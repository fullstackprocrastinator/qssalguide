<!DOCTYPE html>
<html lang="en-GB" class="h-full">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>The Quantity Surveyors Salary Guide</title>
    <meta
      name="description"
      content="Community-powered salary guide for Quantity Surveyors. Contribute entries and explore charts by role and area."
    />

    <link rel="icon" href="/favicon.ico" />
    <meta name="theme-color" content="#0f766e" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: { brand: { 600: "#0f766e", 700: "#0d5a55" } },
            borderRadius: { "3xl": "1.5rem" },
            fontFamily: {
              sans: [
                "Inter",
                "ui-sans-serif",
                "system-ui",
                "-apple-system",
                "Segoe UI",
                "Roboto",
                "Helvetica",
                "Arial",
                "Noto Sans",
                "sans-serif",
              ],
            },
          },
        },
      };
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2.45.2/dist/umd/supabase.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script
      id="hcaptcha-script"
      async
      defer
      src="https://js.hcaptcha.com/1/api.js"
    ></script>

    <style>
      html,
      body {
        height: 100%;
      }
      body {
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto,
          Helvetica, Arial, "Noto Sans", sans-serif;
      }
      select,
      input {
        background: white;
      }
      .dark select,
      .dark input {
        background: #111827;
        color: #e5e7eb;
        border-color: #374151;
      }
      @media print {
        header,
        .controls,
        .no-print {
          display: none !important;
        }
        main {
          padding: 0 !important;
        }
        .card {
          box-shadow: none !important;
          border: 1px solid #e5e7eb;
        }
      }
    </style>
  </head>
  <body
    class="bg-neutral-50 text-neutral-900 dark:bg-neutral-950 dark:text-neutral-100 h-full"
  >
    <script>
      window.onerror = function (msg, url, line, col, err) {
        const box = document.createElement("pre");
        box.style.cssText =
          "white-space:pre-wrap; background:#fee; color:#900; padding:12px; border:1px solid #f99; border-radius:8px; margin:8px; font-family:ui-monospace, SFMono-Regular, Menlo, monospace;";
        box.textContent =
          "Error: " +
          msg +
          "\n" +
          (err && err.stack ? err.stack : url + ":" + line + ":" + col);
        document.body.insertBefore(box, document.body.firstChild);
      };
    </script>

    <div id="root" class="h-full"></div>

    <script type="text/babel" data-presets="env,react">
      const { useEffect, useMemo, useState, useRef } = React;
      const {
        BarChart,
        Bar,
        XAxis,
        YAxis,
        CartesianGrid,
        Tooltip,
        Legend,
        ResponsiveContainer,
      } = Recharts;

      const CONFIG = {
        SUPABASE_URL: "https://pllafoaiaqlvtnotnmrq.supabase.co",
        SUPABASE_ANON_KEY:
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBsbGFmb2FpYXFsdnRub3RubXJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4ODM2OTIsImV4cCI6MjA3MzQ1OTY5Mn0.PyCJXcxjO6Sa49bBPd8VwW4-rtrR1_E4mqfNgja9aoA",
        TABLE_NAME: "entries",
        BRAND_NAME: "The Quantity Surveyors Salary Guide",
        BRAND_COLOUR: "#0f766e",
        LOGO_URL: "",
        FAVICON_URL: "/favicon.ico",
        MODERATION: {
          CONTRIBUTOR_TOKEN: "",
          HCAPTCHA_SITE_KEY: "",
          HCAPTCHA_VERIFY_ENDPOINT: "",
        },
        PAYWALL: {
          ENABLED: false,
          ACCESS_CODES: ["QS-PRO-2025"],
          LOCKED_FEATURES: { excel: true, csv: false, print: false },
        },
        ADMIN: {
          ENABLED: true,
          // Edge Function endpoints (examples). See chat for function code.
          BASE_URL: "", // e.g. https://<your-supabase-project>.functions.supabase.co
          TOKEN: "", // set a strong secret; must match Edge Function
          ENDPOINTS: {
            LIST: "/list-pending",
            APPROVE: "/approve",
            DELETE: "/delete",
          },
        },
      };

      const ROLE_OPTIONS = [
        "Trainee QS",
        "Assistant QS",
        "Quantity Surveyor",
        "Senior QS",
        "Managing QS",
        "Commercial Manager",
        "Senior Commercial Manager",
        "Associate QS",
        "Head of Commercial",
        "Director of QS",
        "Estimator",
        "Senior Estimator",
        "Cost Manager",
        "Senior Cost Manager",
      ];
      const YEARS = Array.from({ length: 41 }, (_, i) => i);
      const SALARY_BRACKETS = [
        { label: "Under £20,000", min: 0, max: 20000 },
        { label: "£20,000 – £25,000", min: 20000, max: 25000 },
        { label: "£25,000 – £30,000", min: 25000, max: 30000 },
        { label: "£30,000 – £35,000", min: 30000, max: 35000 },
        { label: "£35,000 – £40,000", min: 35000, max: 40000 },
        { label: "£40,000 – £45,000", min: 40000, max: 45000 },
        { label: "£45,000 – £50,000", min: 45000, max: 50000 },
        { label: "£50,000 – £60,000", min: 50000, max: 60000 },
        { label: "£60,000 – £70,000", min: 60000, max: 70000 },
        { label: "£70,000 – £80,000", min: 70000, max: 80000 },
        { label: "£80,000 – £90,000", min: 80000, max: 90000 },
        { label: "£90,000 – £100,000", min: 90000, max: 100000 },
        { label: "£100,000 – £120,000", min: 100000, max: 120000 },
        { label: "£120,000 – £150,000", min: 120000, max: 150000 },
        { label: "Over £150,000", min: 150000, max: 9999999 },
      ];

      const FALLBACK_COUNTIES = [
        "Bedfordshire",
        "Berkshire",
        "Bristol",
        "Buckinghamshire",
        "Cambridgeshire",
        "Cheshire",
        "City of London",
        "Cornwall",
        "Cumbria",
        "Derbyshire",
        "Devon",
        "Dorset",
        "County Durham",
        "East Riding of Yorkshire",
        "East Sussex",
        "Essex",
        "Gloucestershire",
        "Greater London",
        "Greater Manchester",
        "Hampshire",
        "Herefordshire",
        "Hertfordshire",
        "Isle of Wight",
        "Kent",
        "Lancashire",
        "Leicestershire",
        "Lincolnshire",
        "Merseyside",
        "Norfolk",
        "North Yorkshire",
        "Northamptonshire",
        "Northumberland",
        "Nottinghamshire",
        "Oxfordshire",
        "Rutland",
        "Shropshire",
        "Somerset",
        "South Yorkshire",
        "Staffordshire",
        "Suffolk",
        "Surrey",
        "Tyne and Wear",
        "Warwickshire",
        "West Midlands",
        "West Sussex",
        "West Yorkshire",
        "Wiltshire",
        "Worcestershire",
        "Anglesey",
        "Blaenau Gwent",
        "Bridgend",
        "Caerphilly",
        "Cardiff",
        "Carmarthenshire",
        "Ceredigion",
        "Conwy",
        "Denbighshire",
        "Flintshire",
        "Gwynedd",
        "Merthyr Tydfil",
        "Monmouthshire",
        "Neath Port Talbot",
        "Newport",
        "Pembrokeshire",
        "Powys",
        "Rhondda Cynon Taf",
        "Swansea",
        "Torfaen",
        "Vale of Glamorgan",
        "Wrexham",
        "Aberdeen City",
        "Aberdeenshire",
        "Angus",
        "Argyll and Bute",
        "Clackmannanshire",
        "Dumfries and Galloway",
        "Dundee City",
        "East Ayrshire",
        "East Dunbartonshire",
        "East Lothian",
        "East Renfrewshire",
        "Edinburgh",
        "Falkirk",
        "Fife",
        "Glasgow City",
        "Highland",
        "Inverclyde",
        "Midlothian",
        "Moray",
        "Na h-Eileanan Siar",
        "North Ayrshire",
        "North Lanarkshire",
        "Orkney Islands",
        "Perth and Kinross",
        "Renfrewshire",
        "Scottish Borders",
        "Shetland Islands",
        "South Ayrshire",
        "South Lanarkshire",
        "Stirling",
        "West Dunbartonshire",
        "West Lothian",
        "Antrim and Newtownabbey",
        "Ards and North Down",
        "Armagh City, Banbridge and Craigavon",
        "Belfast",
        "Causeway Coast and Glens",
        "Derry City and Strabane",
        "Fermanagh and Omagh",
        "Lisburn and Castlereagh",
        "Mid and East Antrim",
        "Mid Ulster",
        "Newry, Mourne and Down",
      ];
      const FALLBACK_CITIES = [
        "London",
        "Birmingham",
        "Manchester",
        "Leeds",
        "Glasgow",
        "Newcastle",
        "Sheffield",
        "Liverpool",
        "Bristol",
        "Nottingham",
        "Leicester",
        "Edinburgh",
        "Cardiff",
        "Belfast",
        "Southampton",
        "Portsmouth",
        "Cambridge",
        "Oxford",
        "Reading",
        "Milton Keynes",
        "Derby",
        "Coventry",
        "Kingston upon Hull",
        "Plymouth",
        "Exeter",
        "Norwich",
        "York",
        "Swansea",
        "Stoke-on-Trent",
      ];

      const salaryMidpoint = (min, max) => Math.round((min + max) / 2);
      const fmtGBP = (n) =>
        new Intl.NumberFormat("en-GB", {
          style: "currency",
          currency: "GBP",
          maximumFractionDigits: 0,
        }).format(n);

      let supabaseClient = null;
      if (CONFIG.SUPABASE_URL && CONFIG.SUPABASE_ANON_KEY) {
        supabaseClient = supabase.createClient(
          CONFIG.SUPABASE_URL,
          CONFIG.SUPABASE_ANON_KEY,
          { auth: { persistSession: true } }
        );
      }

      function useTheme() {
        const [dark, setDark] = useState(
          () => localStorage.getItem("theme") === "dark"
        );
        useEffect(() => {
          const root = document.documentElement;
          if (dark) {
            root.classList.add("dark");
            localStorage.setItem("theme", "dark");
          } else {
            root.classList.remove("dark");
            localStorage.setItem("theme", "light");
          }
        }, [dark]);
        return { dark, setDark };
      }

      function App() {
        const { dark, setDark } = useTheme();
        const [rows, setRows] = useState([]);
        const [countries, setCountries] = useState(["United Kingdom"]);
        const [gazetteer, setGazetteer] = useState(null);
        const [pending, setPending] = useState([]);

        const [q, setQ] = useState("");
        const [filters, setFilters] = useState({ role: "", country: "" });

        const [role, setRole] = useState(ROLE_OPTIONS[0]);
        const [years, setYears] = useState(0);
        const [country, setCountry] = useState("United Kingdom");
        const [county, setCounty] = useState("");
        const [city, setCity] = useState("");
        const [salary, setSalary] = useState(SALARY_BRACKETS[3]);
        const [token, setToken] = useState("");
        const [hToken, setHToken] = useState("");

        const [adminOpen, setAdminOpen] = useState(false);
        const [adminAuthed, setAdminAuthed] = useState(false);
        const [adminToken, setAdminToken] = useState("");
        const isUK = country === "United Kingdom";

        useEffect(() => {
          document
            .querySelector('meta[name="theme-color"]')
            .setAttribute("content", CONFIG.BRAND_COLOUR || "#0f766e");
          if (CONFIG.FAVICON_URL) {
            const link = document.querySelector('link[rel="icon"]');
            link && link.setAttribute("href", CONFIG.FAVICON_URL);
          }
        }, []);

        useEffect(() => {
          fetch("https://restcountries.com/v3.1/all")
            .then((r) => r.json())
            .then((list) =>
              list
                .map((c) => c?.name?.common)
                .filter(Boolean)
                .sort((a, b) => a.localeCompare(b))
            )
            .then(setCountries)
            .catch(() => setCountries(["United Kingdom"]));
        }, []);
        useEffect(() => {
          fetch("uk_places.json")
            .then((r) => (r.ok ? r.json() : Promise.reject()))
            .then((data) => setGazetteer(data))
            .catch(() =>
              setGazetteer({
                counties: Object.fromEntries(
                  FALLBACK_COUNTIES.map((c) => [c, FALLBACK_CITIES])
                ),
              })
            );
        }, []);

        useEffect(() => {
          if (supabaseClient) {
            const load = async () => {
              const { data, error } = await supabaseClient
                .from(CONFIG.TABLE_NAME)
                .select("*")
                .eq("approved", true)
                .order("created_at", { ascending: false })
                .limit(2000);
              if (!error)
                setRows(
                  data.map((d) => ({
                    id: d.id,
                    role: d.role,
                    years: d.years,
                    country: d.country,
                    county: d.county || undefined,
                    city: d.city || undefined,
                    salaryLabel: d.salary_label,
                    salaryMid: d.salary_mid,
                    createdAt: Date.parse(d.created_at),
                  }))
                );
            };
            load();
          } else {
            try {
              const raw = localStorage.getItem("qs-salary-guide-data-v1");
              setRows(raw ? JSON.parse(raw) : []);
            } catch {
              setRows([]);
            }
          }
        }, []);

        const saveLocal = (rows) => {
          try {
            localStorage.setItem(
              "qs-salary-guide-data-v1",
              JSON.stringify(rows)
            );
          } catch {}
        };

        const insertRow = async (newRow) => {
          if (supabaseClient) {
            const payload = {
              role: newRow.role,
              years: newRow.years,
              country: newRow.country,
              county: newRow.county || null,
              city: newRow.city || null,
              salary_label: newRow.salaryLabel,
              salary_mid: newRow.salaryMid,
              approved: false,
            };
            const { error } = await supabaseClient
              .from(CONFIG.TABLE_NAME)
              .insert(payload);
            if (error) {
              alert("Error saving to database: " + error.message);
            } else {
              alert("Thanks! Your entry has been submitted for approval.");
            }
          } else {
            const next = [newRow, ...rows];
            setRows(next);
            saveLocal(next);
          }
        };

        const addRow = async (e) => {
          e.preventDefault();
          if (
            CONFIG.MODERATION.CONTRIBUTOR_TOKEN &&
            token !== CONFIG.MODERATION.CONTRIBUTOR_TOKEN
          ) {
            alert("Invalid contributor token.");
            return;
          }
          if (CONFIG.MODERATION.HCAPTCHA_SITE_KEY && !hToken) {
            alert("Please complete hCaptcha.");
            return;
          }
          if (
            CONFIG.MODERATION.HCAPTCHA_SITE_KEY &&
            CONFIG.MODERATION.HCAPTCHA_VERIFY_ENDPOINT
          ) {
            try {
              const res = await fetch(
                CONFIG.MODERATION.HCAPTCHA_VERIFY_ENDPOINT,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ token: hToken }),
                }
              );
              const { success } = await res.json();
              if (!success) {
                alert("Captcha verification failed.");
                return;
              }
            } catch {
              alert("Captcha verification service unavailable.");
              return;
            }
          }
          const id =
            crypto?.randomUUID?.() || Math.random().toString(36).slice(2);
          const mid = salaryMidpoint(salary.min, salary.max);
          const newRow = {
            id,
            role,
            years: Number(years),
            country,
            county: isUK ? county : undefined,
            city: isUK ? city : undefined,
            salaryLabel: salary.label,
            salaryMid: mid,
            createdAt: Date.now(),
          };
          await insertRow(newRow);
          setRole(ROLE_OPTIONS[0]);
          setYears(0);
          if (isUK) {
            setCounty("");
            setCity("");
          }
          setSalary(SALARY_BRACKETS[3]);
          setHToken("");
          const widget = document.querySelector(".h-captcha");
          if (widget && window.hcaptcha) {
            window.hcaptcha.reset();
          }
        };

        const filtered = useMemo(() => {
          let data = rows;
          if (q.trim()) {
            const t = q.toLowerCase();
            data = data.filter((r) =>
              [
                r.role,
                String(r.years),
                r.country,
                r.county ?? "",
                r.city ?? "",
                r.salaryLabel,
              ]
                .join(" ")
                .toLowerCase()
                .includes(t)
            );
          }
          if (filters.role) data = data.filter((r) => r.role === filters.role);
          if (filters.country)
            data = data.filter((r) => r.country === filters.country);
          return data;
        }, [rows, q, filters]);

        const statsByRole = useMemo(() => {
          const map = new Map();
          for (const r of filtered) {
            const m = map.get(r.role) || { role: r.role, count: 0, avg: 0 };
            m.count += 1;
            m.avg += r.salaryMid;
            map.set(r.role, m);
          }
          return Array.from(map.values())
            .map((d) => ({
              ...d,
              avg: d.count ? Math.round(d.avg / d.count) : 0,
            }))
            .sort((a, b) => a.role.localeCompare(b.role));
        }, [filtered]);
        const statsByCountry = useMemo(() => {
          const map = new Map();
          for (const r of filtered) {
            const k = r.country;
            const m = map.get(k) || { country: k, count: 0, avg: 0 };
            m.count += 1;
            m.avg += r.salaryMid;
            map.set(k, m);
          }
          return Array.from(map.values())
            .map((d) => ({
              ...d,
              avg: d.count ? Math.round(d.avg / d.count) : 0,
            }))
            .sort((a, b) => b.count - a.count)
            .slice(0, 12);
        }, [filtered]);
        const statsUKByCounty = useMemo(() => {
          const map = new Map();
          for (const r of filtered) {
            if (r.country !== "United Kingdom" || !r.county) continue;
            const k = r.county;
            const m = map.get(k) || { county: k, count: 0, avg: 0 };
            m.count += 1;
            m.avg += r.salaryMid;
            map.set(k, m);
          }
          return Array.from(map.values())
            .map((d) => ({
              ...d,
              avg: d.count ? Math.round(d.avg / d.count) : 0,
            }))
            .sort((a, b) => b.count - a.count)
            .slice(0, 15);
        }, [filtered]);

        // ---------------- Admin helpers (Edge Functions) ----------------
        const adminFetch = async (path, body) => {
          if (!CONFIG.ADMIN.BASE_URL) {
            alert("Admin API not configured.");
            return { ok: false };
          }
          const res = await fetch(CONFIG.ADMIN.BASE_URL + path, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Admin-Token": adminToken || CONFIG.ADMIN.TOKEN,
            },
            body: JSON.stringify(body || {}),
          });
          try {
            const data = await res.json();
            return { ok: res.ok, data };
          } catch {
            return { ok: false, data: null };
          }
        };
        const loadPending = async () => {
          const { ok, data } = await adminFetch(CONFIG.ADMIN.ENDPOINTS.LIST);
          if (ok) setPending(data?.rows || []);
          else alert("Failed to load pending.");
        };
        const approve = async (id) => {
          const { ok } = await adminFetch(CONFIG.ADMIN.ENDPOINTS.APPROVE, {
            id,
          });
          if (ok) {
            setPending((p) => p.filter((r) => r.id !== id));
            refreshApproved();
          } else alert("Approve failed");
        };
        const remove = async (id) => {
          const { ok } = await adminFetch(CONFIG.ADMIN.ENDPOINTS.DELETE, {
            id,
          });
          if (ok) setPending((p) => p.filter((r) => r.id !== id));
          else alert("Delete failed");
        };
        const refreshApproved = async () => {
          if (!supabaseClient) return;
          const { data, error } = await supabaseClient
            .from(CONFIG.TABLE_NAME)
            .select("*")
            .eq("approved", true)
            .order("created_at", { ascending: false })
            .limit(2000);
          if (!error)
            setRows(
              data.map((d) => ({
                id: d.id,
                role: d.role,
                years: d.years,
                country: d.country,
                county: d.county || undefined,
                city: d.city || undefined,
                salaryLabel: d.salary_label,
                salaryMid: d.salary_mid,
                createdAt: Date.parse(d.created_at),
              }))
            );
        };

        const counties = gazetteer?.counties
          ? Object.keys(gazetteer.counties)
          : FALLBACK_COUNTIES;
        const citiesForCounty =
          county && gazetteer?.counties?.[county]
            ? gazetteer.counties[county]
            : FALLBACK_CITIES;

        return (
          <div className="min-h-full">
            <header className="controls sticky top-0 z-30 backdrop-blur bg-white/70 dark:bg-neutral-950/70 border-b border-neutral-200 dark:border-neutral-800">
              <div className="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
                {CONFIG.LOGO_URL && (
                  <img
                    src={CONFIG.LOGO_URL}
                    alt="Logo"
                    className="w-8 h-8 rounded"
                  />
                )}
                <h1
                  className="text-xl sm:text-2xl font-semibold tracking-tight"
                  style={{ color: CONFIG.BRAND_COLOUR }}
                >
                  {CONFIG.BRAND_NAME}
                </h1>
                <div className="ml-auto flex items-center gap-2">
                  <button
                    onClick={() => setDark((v) => !v)}
                    className="px-3 py-1.5 rounded-2xl border border-neutral-300 dark:border-neutral-700 text-sm"
                  >
                    {dark ? "Light" : "Dark"} mode
                  </button>
                  <button
                    onClick={() => setAdminOpen(true)}
                    className="px-3 py-1.5 rounded-2xl border border-neutral-300 dark:border-neutral-700 text-sm"
                  >
                    Admin
                  </button>
                </div>
              </div>
            </header>

            <main className="max-w-7xl mx-auto px-4 py-6 grid gap-6">
              <section className="card bg-white dark:bg-neutral-900 rounded-3xl p-5 shadow-sm border border-neutral-200 dark:border-neutral-800">
                <p className="text-neutral-700 dark:text-neutral-300">
                  Add salary data anonymously below. UK selection reveals county
                  + city/town. Submissions now require approval.
                </p>
              </section>

              <section className="card bg-white dark:bg-neutral-900 rounded-3xl p-5 shadow-sm border border-neutral-200 dark:border-neutral-800">
                <form
                  onSubmit={addRow}
                  className="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"
                >
                  <div>
                    <label className="block text-sm mb-1">Role</label>
                    <select
                      value={role}
                      onChange={(e) => setRole(e.target.value)}
                      className="w-full rounded-2xl border border-neutral-300 dark:border-neutral-700 focus:ring-2 focus:ring-brand-600 p-2"
                    >
                      {ROLE_OPTIONS.map((r) => (
                        <option key={r} value={r}>
                          {r}
                        </option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm mb-1">
                      Time in role (years)
                    </label>
                    <select
                      value={years}
                      onChange={(e) => setYears(Number(e.target.value))}
                      className="w-full rounded-2xl border border-neutral-300 dark:border-neutral-700 focus:ring-2 focus:ring-brand-600 p-2"
                    >
                      {YEARS.map((y) => (
                        <option key={y} value={y}>
                          {y}
                        </option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm mb-1">Country</label>
                    <select
                      value={country}
                      onChange={(e) => setCountry(e.target.value)}
                      className="w-full rounded-2xl border border-neutral-300 dark:border-neutral-700 focus:ring-2 focus:ring-brand-600 p-2"
                    >
                      {countries.map((c) => (
                        <option key={c} value={c}>
                          {c}
                        </option>
                      ))}
                    </select>
                  </div>
                  {isUK && (
                    <>
                      <div>
                        <label className="block text-sm mb-1">County</label>
                        <select
                          value={county}
                          onChange={(e) => setCounty(e.target.value)}
                          className="w-full rounded-2xl border border-neutral-300 dark:border-neutral-700 focus:ring-2 focus:ring-brand-600 p-2"
                        >
                          <option value="">Select a county…</option>
                          {counties.map((c) => (
                            <option key={c} value={c}>
                              {c}
                            </option>
                          ))}
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm mb-1">
                          City / Town
                        </label>
                        <select
                          value={city}
                          onChange={(e) => setCity(e.target.value)}
                          className="w-full rounded-2xl border border-neutral-300 dark:border-neutral-700 focus:ring-2 focus:ring-brand-600 p-2"
                        >
                          <option value="">Select a city…</option>
                          {citiesForCounty.map((c) => (
                            <option key={c} value={c}>
                              {c}
                            </option>
                          ))}
                        </select>
                      </div>
                    </>
                  )}
                  <div>
                    <label className="block text-sm mb-1">
                      Salary bracket (gross, per annum)
                    </label>
                    <select
                      value={salary.label}
                      onChange={(e) =>
                        setSalary(
                          SALARY_BRACKETS.find(
                            (x) => x.label === e.target.value
                          )
                        )
                      }
                      className="w-full rounded-2xl border border-neutral-300 dark:border-neutral-700 focus:ring-2 focus:ring-brand-600 p-2"
                    >
                      {SALARY_BRACKETS.map((s) => (
                        <option key={s.label} value={s.label}>
                          {s.label}
                        </option>
                      ))}
                    </select>
                  </div>
                  {(CONFIG.MODERATION.CONTRIBUTOR_TOKEN ||
                    CONFIG.MODERATION.HCAPTCHA_SITE_KEY) && (
                    <div className="sm:col-span-2 lg:col-span-3 grid sm:grid-cols-2 gap-4">
                      {CONFIG.MODERATION.CONTRIBUTOR_TOKEN && (
                        <div>
                          <label className="block text-sm mb-1">
                            Contributor token
                          </label>
                          <input
                            value={token}
                            onChange={(e) => setToken(e.target.value)}
                            placeholder="Enter the shared token"
                            className="w-full rounded-2xl border border-neutral-300 dark:border-neutral-700 focus:ring-2 focus:ring-brand-600 p-2"
                          />
                        </div>
                      )}
                      {CONFIG.MODERATION.HCAPTCHA_SITE_KEY && (
                        <div>
                          <div
                            className="h-captcha"
                            data-sitekey={CONFIG.MODERATION.HCAPTCHA_SITE_KEY}
                            data-callback={(t) => {
                              setHToken(t);
                            }}
                          ></div>
                        </div>
                      )}
                    </div>
                  )}
                  <div className="sm:col-span-2 lg:col-span-3 flex items-end gap-3">
                    <button
                      type="submit"
                      className="px-4 py-2 rounded-2xl bg-brand-600 text-white hover:bg-brand-700 transition shadow"
                    >
                      Submit for approval
                    </button>
                  </div>
                </form>
              </section>

              <section className="controls grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <div className="card bg-white dark:bg-neutral-900 rounded-3xl p-4 shadow-sm border border-neutral-200 dark:border-neutral-800">
                  <label className="block text-sm mb-1">
                    Search all fields
                  </label>
                  <input
                    value={q}
                    onChange={(e) => setQ(e.target.value)}
                    placeholder="Type to search…"
                    className="w-full rounded-2xl border border-neutral-300 dark:border-neutral-700 focus:ring-2 focus:ring-brand-600 p-2"
                  />
                </div>
                <div className="card bg-white dark:bg-neutral-900 rounded-3xl p-4 shadow-sm border border-neutral-200 dark:border-neutral-800">
                  <label className="block text-sm mb-1">Filter by role</label>
                  <select
                    value={filters.role}
                    onChange={(e) =>
                      setFilters((prev) => ({ ...prev, role: e.target.value }))
                    }
                    className="w-full rounded-2xl border border-neutral-300 dark:border-neutral-700 focus:ring-2 focus:ring-brand-600 p-2"
                  >
                    <option value="">All roles</option>
                    {ROLE_OPTIONS.map((r) => (
                      <option key={r} value={r}>
                        {r}
                      </option>
                    ))}
                  </select>
                </div>
                <div className="card bg-white dark:bg-neutral-900 rounded-3xl p-4 shadow-sm border border-neutral-200 dark:border-neutral-800">
                  <label className="block text-sm mb-1">
                    Filter by country
                  </label>
                  <select
                    value={filters.country}
                    onChange={(e) =>
                      setFilters((prev) => ({
                        ...prev,
                        country: e.target.value,
                      }))
                    }
                    className="w-full rounded-2xl border border-neutral-300 dark:border-neutral-700 focus:ring-2 focus:ring-brand-600 p-2"
                  >
                    <option value="">All countries</option>
                    {countries.map((c) => (
                      <option key={c} value={c}>
                        {c}
                      </option>
                    ))}
                  </select>
                </div>
              </section>

              <section className="card bg-white dark:bg-neutral-900 rounded-3xl p-5 shadow-sm border border-neutral-200 dark:border-neutral-800 overflow-hidden">
                <div className="flex items-center justify-between gap-3 mb-3">
                  <h2 className="text-lg font-semibold">Approved entries</h2>
                  <span className="text-sm text-neutral-500 dark:text-neutral-400">
                    {filtered.length} shown
                  </span>
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead>
                      <tr className="text-left bg-neutral-50 dark:bg-neutral-800/60">
                        <th className="px-3 py-2">Role</th>
                        <th className="px-3 py-2">Years</th>
                        <th className="px-3 py-2">Country</th>
                        <th className="px-3 py-2">County</th>
                        <th className="px-3 py-2">City/Town</th>
                        <th className="px-3 py-2">Salary bracket</th>
                        <th className="px-3 py-2">Mid (£)</th>
                        <th className="px-3 py-2">Submitted</th>
                      </tr>
                    </thead>
                    <tbody>
                      {filtered.map((r) => (
                        <tr
                          key={r.id}
                          className="border-t border-neutral-200 dark:border-neutral-800 hover:bg-neutral-50 dark:hover:bg-neutral-800/40"
                        >
                          <td className="px-3 py-2 whitespace-nowrap">
                            {r.role}
                          </td>
                          <td className="px-3 py-2 whitespace-nowrap">
                            {r.years}
                          </td>
                          <td className="px-3 py-2 whitespace-nowrap">
                            {r.country}
                          </td>
                          <td className="px-3 py-2 whitespace-nowrap">
                            {r.county ?? "—"}
                          </td>
                          <td className="px-3 py-2 whitespace-nowrap">
                            {r.city ?? "—"}
                          </td>
                          <td className="px-3 py-2 whitespace-nowrap">
                            {r.salaryLabel}
                          </td>
                          <td className="px-3 py-2 whitespace-nowrap">
                            {fmtGBP(r.salaryMid)}
                          </td>
                          <td className="px-3 py-2 whitespace-nowrap">
                            {new Date(r.createdAt).toLocaleString("en-GB")}
                          </td>
                        </tr>
                      ))}
                      {filtered.length === 0 && (
                        <tr>
                          <td
                            colSpan="8"
                            className="px-3 py-6 text-center text-neutral-500 dark:text-neutral-400"
                          >
                            No entries yet.
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
              </section>

              <section className="grid lg:grid-cols-2 gap-6">
                <div className="card bg-white dark:bg-neutral-900 rounded-3xl p-5 shadow-sm border border-neutral-200 dark:border-neutral-800">
                  <div className="flex items-center justify-between mb-3">
                    <h3 className="font-semibold">Entries by role</h3>
                    <span className="text-sm text-neutral-500 dark:text-neutral-400">
                      Count
                    </span>
                  </div>
                  <div className="h-72">
                    <ResponsiveContainer width="100%" height="100%">
                      <BarChart
                        data={statsByRole}
                        margin={{ top: 5, right: 20, bottom: 20, left: 0 }}
                      >
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis
                          dataKey="role"
                          angle={-20}
                          textAnchor="end"
                          interval={0}
                          height={60}
                        />
                        <YAxis allowDecimals={false} />
                        <Tooltip
                          formatter={(v, n) => [
                            v,
                            n === "count" ? "Entries" : "Average £",
                          ]}
                        />
                        <Legend />
                        <Bar dataKey="count" name="Entries" />
                      </BarChart>
                    </ResponsiveContainer>
                  </div>
                </div>
                <div className="card bg-white dark:bg-neutral-900 rounded-3xl p-5 shadow-sm border border-neutral-200 dark:border-neutral-800">
                  <div className="flex items-center justify-between mb-3">
                    <h3 className="font-semibold">
                      Average salary by country (top 12)
                    </h3>
                    <span className="text-sm text-neutral-500 dark:text-neutral-400">
                      £ per annum
                    </span>
                  </div>
                  <div className="h-72">
                    <ResponsiveContainer width="100%" height="100%">
                      <BarChart
                        data={statsByCountry}
                        layout="vertical"
                        margin={{ top: 5, right: 20, bottom: 20, left: 0 }}
                      >
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis
                          type="number"
                          tickFormatter={(v) => fmtGBP(v).replace("£", "")}
                        />
                        <YAxis type="category" dataKey="country" width={140} />
                        <Tooltip formatter={(v) => fmtGBP(Number(v))} />
                        <Legend />
                        <Bar dataKey="avg" name="Average" />
                      </BarChart>
                    </ResponsiveContainer>
                  </div>
                </div>
              </section>

              <section className="card bg-white dark:bg-neutral-900 rounded-3xl p-5 shadow-sm border border-neutral-200 dark:border-neutral-800">
                <div className="flex items-center justify-between mb-3">
                  <h3 className="font-semibold">
                    United Kingdom – average salary by county (top 15)
                  </h3>
                  <span className="text-sm text-neutral-500 dark:text-neutral-400">
                    £ per annum
                  </span>
                </div>
                <div className="h-80">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart
                      data={statsUKByCounty}
                      layout="vertical"
                      margin={{ top: 5, right: 20, bottom: 20, left: 0 }}
                    >
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis
                        type="number"
                        tickFormatter={(v) => fmtGBP(v).replace("£", "")}
                      />
                      <YAxis type="category" dataKey="county" width={200} />
                      <Tooltip formatter={(v) => fmtGBP(Number(v))} />
                      <Legend />
                      <Bar dataKey="avg" name="Average" />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </section>

              <footer className="text-center text-xs text-neutral-500 dark:text-neutral-400 pb-8">
                Built for the QS community · Submissions require admin approval
                · Dark mode supported.
              </footer>
            </main>

            {/* Admin modal */}
            {CONFIG.ADMIN.ENABLED && adminOpen && (
              <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4">
                <div className="bg-white dark:bg-neutral-900 rounded-3xl shadow-xl border border-neutral-200 dark:border-neutral-800 max-w-3xl w-full">
                  <div className="p-4 border-b border-neutral-200 dark:border-neutral-800 flex items-center justify-between">
                    <h3 className="font-semibold">Admin — Pending approvals</h3>
                    <button
                      onClick={() => setAdminOpen(false)}
                      className="text-sm px-2 py-1 rounded-2xl border border-neutral-300 dark:border-neutral-700"
                    >
                      Close
                    </button>
                  </div>

                  {!adminAuthed ? (
                    <div className="p-4 space-y-3">
                      <p className="text-sm text-neutral-600 dark:text-neutral-400">
                        Enter your admin token to continue.
                      </p>
                      <input
                        value={adminToken}
                        onChange={(e) => setAdminToken(e.target.value)}
                        placeholder="Admin token"
                        className="w-full rounded-2xl border border-neutral-300 dark:border-neutral-700 p-2"
                      />
                      <div className="flex gap-2">
                        <button
                          onClick={() => {
                            if (adminToken || CONFIG.ADMIN.TOKEN) {
                              setAdminAuthed(true);
                              loadPending();
                            } else alert("Please enter token");
                          }}
                          className="px-4 py-2 rounded-2xl bg-brand-600 text-white"
                        >
                          Unlock
                        </button>
                        <button
                          onClick={() => loadPending()}
                          className="px-4 py-2 rounded-2xl border border-neutral-300 dark:border-neutral-700"
                        >
                          Refresh
                        </button>
                      </div>
                    </div>
                  ) : (
                    <div className="p-4 max-h-[70vh] overflow-y-auto">
                      {pending.length === 0 ? (
                        <p className="text-sm text-neutral-600 dark:text-neutral-400">
                          No pending entries.
                        </p>
                      ) : (
                        <table className="w-full text-sm">
                          <thead>
                            <tr className="text-left bg-neutral-50 dark:bg-neutral-800/60">
                              <th className="px-3 py-2">Role</th>
                              <th className="px-3 py-2">Years</th>
                              <th className="px-3 py-2">Location</th>
                              <th className="px-3 py-2">Salary</th>
                              <th className="px-3 py-2">Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            {pending.map((r) => (
                              <tr
                                key={r.id}
                                className="border-t border-neutral-200 dark:border-neutral-800"
                              >
                                <td className="px-3 py-2 whitespace-nowrap">
                                  {r.role}
                                </td>
                                <td className="px-3 py-2 whitespace-nowrap">
                                  {r.years}
                                </td>
                                <td className="px-3 py-2 whitespace-nowrap">
                                  {r.country}
                                  {r.county ? `, ${r.county}` : ""}
                                  {r.city ? `, ${r.city}` : ""}
                                </td>
                                <td className="px-3 py-2 whitespace-nowrap">
                                  {r.salary_label} ({fmtGBP(r.salary_mid)})
                                </td>
                                <td className="px-3 py-2 whitespace-nowrap flex gap-2">
                                  <button
                                    onClick={() => approve(r.id)}
                                    className="px-2 py-1 rounded-2xl bg-green-600 text-white"
                                  >
                                    Approve
                                  </button>
                                  <button
                                    onClick={() => remove(r.id)}
                                    className="px-2 py-1 rounded-2xl bg-red-600 text-white"
                                  >
                                    Delete
                                  </button>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      )}
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
